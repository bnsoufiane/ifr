/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.3.7
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(t){return t=t||require("lodash"),e(t)}:"function"==typeof define&&define.amd?define(["lodash"],function(n){return e(n,t)}):t.machina=e(t._,t)})(this,function(t,e,n){var i=[].slice,s="transition",r="handler",a="handling",o="handled",u="nohandler",c="transition",h="invalidstate",l="deferred",f="newfsm",p={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:p.makeFsmNamespace(),targetReplayState:"",state:n,priorState:n,_priorAction:"",_currentAction:""}}};if(!t.deepExtend){var d={"*":function(t,e,n){t[e]=n},object:function(t,e,n){t[e]=y({},t[e]||{},n)},array:function(e,n,i){e[n]=[],t.each(i,function(t,i){d[g(t)](e[n],i,t)},this)}},v=function(e){return t.isArray(e)?"array":t.isDate(e)?"date":t.isRegExp(e)?"regex":typeof e},g=function(t){var e=v(t);return d[e]?e:"*"},y=function(e){return t.each(i.call(arguments,1),function(n){t.each(n,function(t,n){d[g(t)](e,n,t)})}),e};t.mixin({deepExtend:y})}var m=function(e){t.extend(this,e),t.defaults(this,p.getDefaultOptions()),this.initialize.apply(this,arguments),A.emit(f,this),this.initialState&&this.transition(this.initialState)};t.extend(m.prototype,{initialize:function(){},emit:function(e){var n=arguments;this.eventListeners["*"]&&t.each(this.eventListeners["*"],function(t){try{t.apply(this,i.call(n,0))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.toString())}},this),this.eventListeners[e]&&t.each(this.eventListeners[e],function(t){try{t.apply(this,i.call(n,1))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.toString())}},this)},handle:function(e){if(!this.inExitHandler){var s,c,h,l,f=this.states,p=this.state,d=i.call(arguments,0);this.currentActionArgs=d,f[p][e]||f[p]["*"]||this["*"]?(s=f[p][e]?e:"*",h="*"===s,f[p][s]?(c=f[p][s],l=p+"."+s):(c=this["*"],l="*"),this._currentAction||(this._currentAction=l),this.emit.call(this,a,{inputType:e,args:d.slice(1)}),t.isFunction(c)&&(c=c.apply(this,h?d:d.slice(1))),t.isString(c)&&this.transition(c),this.emit.call(this,o,{inputType:e,args:d.slice(1)}),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(r)):this.emit.call(this,u,{inputType:e,args:d.slice(1)}),this.currentActionArgs=n}},transition:function(t){if(!this.inExitHandler&&t!==this.state){var e=this.state;if(this.states[t])return this.states[e]&&this.states[e]._onExit&&(this.inExitHandler=!0,this.states[e]._onExit.call(this),this.inExitHandler=!1),this.targetReplayState=t,this.priorState=e,this.state=t,this.emit.call(this,c,{fromState:this.priorState,action:this._currentAction,toState:t}),this.states[t]._onEnter&&this.states[t]._onEnter.call(this),void(this.targetReplayState===t&&this.processQueue(s));this.emit.call(this,h,{state:this.state,attemptedState:t})}},processQueue:function(e){var n=e===s?function(t){return t.type===s&&(!t.untilState||t.untilState===this.state)}:function(t){return t.type===r},i=t.filter(this.eventQueue,n,this);this.eventQueue=t.difference(this.eventQueue,i),t.each(i,function(t){this.handle.apply(this,t.args)},this)},clearQueue:function(e,n){if(e){var i;e===s?i=function(t){return t.type===s&&(n?t.untilState===n:!0)}:e===r&&(i=function(t){return t.type===r}),this.eventQueue=t.filter(this.eventQueue,i)}else this.eventQueue=[]},deferUntilTransition:function(t){if(this.currentActionArgs){var e={type:s,untilState:t,args:this.currentActionArgs};this.eventQueue.push(e),this.emit.call(this,l,{state:this.state,queuedArgs:e})}},deferUntilNextHandler:function(){if(this.currentActionArgs){var t={type:r,args:this.currentActionArgs};this.eventQueue.push(t),this.emit.call(this,l,{state:this.state,queuedArgs:t})}},on:function(t,e){var n=this;return n.eventListeners[t]||(n.eventListeners[t]=[]),n.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){n.off(t,e)}}},off:function(e,n){e?this.eventListeners[e]&&(this.eventListeners[e]=n?t.without(this.eventListeners[e],n):[]):this.eventListeners={}}}),m.prototype.trigger=m.prototype.emit;var x=function(e,n,s){var r,a={},o=function(){};return r=n&&n.hasOwnProperty("constructor")?n.constructor:function(){var n=i.call(arguments,0);n[0]=t.deepExtend(t.cloneDeep(a),n[0]),e.apply(this,n)},t.deepExtend(r,e),o.prototype=e.prototype,r.prototype=new o,n&&(t.deepExtend(r.prototype,t.transform(n,function(t,e,n){"function"==typeof e&&(t[n]=e)})),t.deepExtend(a,t.transform(n,function(t,e,n){"function"!=typeof e&&(t[n]=e)}))),s&&t.deepExtend(r,s),r.prototype.constructor=r,r.__super__=e.prototype,r};m.extend=function(t,e){var n=x(this,t,e);return n.extend=this.extend,n};var A={Fsm:m,utils:p,on:function(t,e){return this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e),e},off:function(e,n){this.eventListeners[e]&&(this.eventListeners[e]=t.without(this.eventListeners[e],n))},trigger:function(e){var n=arguments,s=this.eventListeners[e]||[];s&&s.length&&t.each(s,function(t){t.apply(null,i.call(n,1))})},eventListeners:{newFsm:[]}};return A.emit=A.trigger,A});